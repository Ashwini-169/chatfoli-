<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenRouter / OpenAI - Test Chat UI</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f4f6f8; margin:0; padding:20px; }
    .container { max-width:760px; margin:0 auto; background:white; border-radius:8px; box-shadow:0 6px 24px rgba(10,20,30,0.08); padding:16px; }
    .header { display:flex; gap:12px; align-items:center; }
    .messages { height:420px; overflow:auto; border:1px solid #e6eef6; padding:12px; margin-top:12px; border-radius:6px; background:#fbfdff }
    .msg { margin:8px 0; }
    .msg.user { text-align:right }
    .bubble { display:inline-block; padding:10px 14px; border-radius:12px; max-width:80%; }
    .bubble.user { background:#0b69ff; color:white }
    .bubble.ai { background:#eef6ff; color:#06233a }
    .controls { display:flex; gap:8px; margin-top:12px; align-items:center }
    input[type=text], select { padding:8px 10px; border-radius:6px; border:1px solid #d8e6f8 }
    button { padding:10px 12px; border-radius:6px; background:#0b69ff; color:white; border:0; cursor:pointer }
    .small { font-size:13px; color:#6b7785 }
    pre { background:#0f1720; color:#e6eef6; padding:12px; border-radius:6px; overflow:auto }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>OpenRouter Test Chat</h2>
      <div class="small">Sends POST /api/openrouter (you must wire backend)</div>
    </div>

    <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
      <label class="small">Model:</label>
      <select id="model">
        <option value="openai/gpt-oss-20b:free">openai/gpt-oss-20b:free</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
      </select>
      <label class="small">Site URL:</label>
      <input id="site_url" type="text" placeholder="https://example.com" style="width:220px" />
      <label class="small">Site title:</label>
      <input id="site_title" type="text" placeholder="MySite" style="width:140px" />
    </div>

    <div class="messages" id="messages"></div>

    <div class="controls">
      <input id="input" type="text" placeholder="Type your message... (press Enter to send)" style="flex:1" />
      <button id="send">Send</button>
      <button id="clear" style="background:#f3f4f6;color:#0b69ff;border:1px solid #dbeafe">Clear</button>
    </div>

    <div style="margin-top:12px">
      <div class="small">Raw assistant JSON (if present):</div>
      <pre id="raw" style="height:160px">(no JSON yet)</pre>
    </div>
  </div>

<script>
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');
const clearBtn = document.getElementById('clear');
const rawEl = document.getElementById('raw');

function appendMessage(text, who='ai'){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='user' ? 'user' : 'ai');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (who==='user' ? 'user' : 'ai');
  bubble.textContent = text;
  div.appendChild(bubble);
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  appendMessage(text, 'user');
  inputEl.value = '';
  rawEl.textContent = '(waiting...)';

  const model = document.getElementById('model').value;
  const site_url = document.getElementById('site_url').value || undefined;
  const site_title = document.getElementById('site_title').value || undefined;

  // Build a minimal conversation history for backend; the backend may accept different shapes
  const payload = {
    messages: [ { role: 'user', content: text } ],
    model, site_url, site_title
  };

  try{
    const res = await fetch('/api/openrouter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const txt = await res.text();
      appendMessage('Error from server: ' + res.status + ' ' + txt, 'ai');
      rawEl.textContent = '(error) ' + txt;
      return;
    }

    const data = await res.json();

    // Expecting { assistantMessage: '...', resumeData: {...} } OR { text: '...', json: {...} }
    let assistantText = data.assistantMessage || data.text || data.message || data.result || '';
    if(!assistantText && data.choices && data.choices[0]){
      try{ assistantText = data.choices[0].message.content }catch(e){}
    }

    // If backend returned structured JSON separately
    const structured = data.resumeData || data.structured_json || data.json || data.data || null;

    if(assistantText) appendMessage(assistantText, 'ai');
    if(structured) rawEl.textContent = JSON.stringify(structured, null, 2);
    else rawEl.textContent = '(no JSON found)';

  }catch(err){
    appendMessage('Network error: ' + err.message, 'ai');
    rawEl.textContent = '(network error) ' + err.message;
  }
}

sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
clearBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; rawEl.textContent='(no JSON yet)'; });

// small welcome
appendMessage('Welcome! Use the input below to send a message to the OpenRouter backend.');
</script>
</body>
</html>